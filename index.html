<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke – Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend,.panel{position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif}
    .legend{bottom:12px;right:12px}
    .legend i{display:inline-block;width:12px;height:12px;margin-right:6px;vertical-align:-2px}
    .panel{top:12px;left:12px;max-width:360px}
    .panel details summary{cursor:pointer;font-weight:600}
    button.small{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer}
    button.small:hover{background:#eee}
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> 🟢 ≤ 260 €</label><br>
  <label><input type="checkbox" id="chkOrange" checked> 🟠 260–285 €</label><br>
  <label><input type="checkbox" id="chkRot" checked> 🔴 ≥ 285 €</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ⚪ kein Preis</label>
</div>

<div class="panel">
  <details open>
    <summary>Hinweise & Status</summary>
    <div style="margin-top:6px">
      • Preise änderst du unten in <code>werke</code> (nur <code>preis</code>).<br>
      • Koordinaten werden automatisch gesucht & gespeichert.<br>
      • Du kannst auch Orte in Polen, Tschechien, Belgien oder den Niederlanden eintragen (z. B. „Kraków, Polen“).<br>
    </div>
    <div style="margin-top:8px">
      <button class="small" id="retryBtn">Fehlende Orte neu suchen</button>
      <button class="small" id="clearCacheBtn">Cache leeren</button>
    </div>
    <div id="status" style="margin-top:8px;max-height:160px;overflow:auto;border-top:1px solid #eee;padding-top:6px"></div>
  </details>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map=L.map('map').setView([51,11],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  minZoom:4,maxZoom:10,attribution:'&copy; OpenStreetMap'
}).addTo(map);

function colorForPrice(p){if(!p||p<=0)return'#9e9e9e';if(p<=260)return'green';if(p<285)return'orange';return'red';}
const CACHE_KEY='geoCachePellets_EU';
const geoCache=JSON.parse(localStorage.getItem(CACHE_KEY)||'{}');
async function geocode(q){
  if(geoCache[q])return geoCache[q];
  const r=await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d=await r.json();
  if(d&&d.length){const{lat,lon}=d[0];geoCache[q]={lat:+lat,lon:+lon};
    localStorage.setItem(CACHE_KEY,JSON.stringify(geoCache));return geoCache[q];}
  throw new Error('kein Treffer für '+q);
}
function delay(ms){return new Promise(r=>setTimeout(r,ms));}

// === Firmen ===
const werke=[
  { firma: "LEAG Pellets GmbH", ort: "23966 Wismar, Deutschland", preis: 235 },
      { firma: "HVW Hobelspanverarbeitung GmbH & Co. KG", ort: "23970 Kritzow-Hornstorf, Deutschland", preis: 265 },
      { firma: "Hanse-Pellet GmbH & Co. KG", ort: "21244 Buchholz, Deutschland", preis: 0 },
      { firma: "Holtmeyer Pellet GmbH", ort: "28870 Ottersberg-Narthauen, Deutschland", preis: 250 },
      { firma: "Holzkontor und Pelletierwerk Schwedt GmbH", ort: "16303 Schwedt, Deutschland", preis: 0 },
      { firma: "Joh. Brandenburg GmbH & Co. KG", ort: "49424 Goldenstedt, Deutschland", preis: 0 },
      { firma: "1 Heiz Pellets AG", ort:  "16225 Eberswalde, Deutschland", preis: 0 },
      { firma: "Biopellet Magdeburg GmbH & Co. KG", ort: "39126 Magdeburg, Deutschland", preis: 0 },
      { firma: "PROPELL GmbH", ort: "Oranienbaum, Deutschland", preis: 0 },
      { firma: "1 Heiz Pellets AG", ort: "03205 Calau, Deutschland", preis: 0 },
      { firma: "EC Bioenergie GmbH", ort: "37181 Hardegsen, Deutschland", preis: 0 },
      { firma: "Ante-Holz GmbH", ort: "06536 Südharz, Deutschland", preis: 0 },
      { firma: "Mercer Torgau GmbH & Co. KG", ort: "04860 Torgau, Deutschland", preis: 0 },
      { firma: "Overbeck Bioenergie GmbH", ort: "45525 Hattingen, Deutschland", preis: 0 },
      { firma: "Josef Baust Holzbetrieb GmbH", ort: "Eslohe-Bremke, Deutschland", preis: 0 },
      { firma: "Pieper Holz GmbH", ort: "59939 Olsberg-Helmeringhausen, Deutschland", preis: 285 },
      { firma: "Prinz-Eugen Energiepark GmbH", ort: "Bad Arolsen, Deutschland", preis: 0 },
      { firma: "Euroline GmbH & Co. KG", ort: "37079 Göttingen, Deutschland", preis: 0 },
      { firma: "J. Freytag GmbH & Co. KG", ort: "34414 Warburg, Deutschland", preis: 0 },
      { firma: "Josef Schmelter GmbH", ort: "5738 Lennestadt, Deutschland", preis: 0 },
      { firma: "HS Timber Productions GmbH", ort: "Kodersdorf, Deutschland", preis: 0 },
      { firma: "WestPellets GmbH & Co. KG", ort: "Titz-Ameln, Deutschland", preis: 0 },
      { firma: "NRW Pellets GmbH", ort: "57339 Erndtebrück, Deutschland", preis: 260 },
      { firma: "Ante-Holz GmbH", ort: "Bromskirchen, Deutschland", preis: 0 },
      { firma: "Danpower Pelletproduktion GmbH", ort: "Osterfeld, Deutschland", preis: 0 },
      { firma: "PROPELL GmbH", ort: "Löbau, Deutschland", preis: 0 },
      { firma: "Holzwerke von Roje GmbH & Co. KG", ort: "Oberhonnefeld-Gierend, Deutschland", preis: 0 },
      { firma: "Holzindustrie Hassel GmbH", ort: "Stockum-Püschen, Deutschland", preis: 0 },
      { firma: "Westerwälder Holzpellets GmbH", ort: "Langenbach, Deutschland", preis: 0 },
      { firma: "Pfeifer Holz GmbH", ort: "Lauterbach (Hessen), Deutschland", preis: 0 },
      { firma: "EPH EnergiePellets Hosenfeld GmbH", ort: "Hosenfeld-Hainzell, Deutschland", preis: 0 },
      { firma: "HVT Hobelspanverarbeitung GmbH", ort: "Dittersdorf, Deutschland", preis: 0 },
      { firma: "EC Bioenergie GmbH", ort: "54497 Morbach, Deutschland", preis: 0 },
      { firma: "EVO - Energieversorgung Offenbach AG", ort: "63075 Offenbach am Main, Deutschland", preis: 0 },
      { firma: "Frankenpellets GmbH & Co. KG", ort: "Stadtsteinach, Deutschland", preis: 0 },
      { firma: "WUN Bioenergie GmbH", ort: "Wunsiedel, Deutschland", preis: 0 },
      { firma: "Ziegler Holding GmbH", ort: "Pressath, Deutschland", preis: 0 },
      { firma: "Gregor Ziegler GmbH", ort: "Plößberg, Deutschland", preis: 0 },
      { firma: "Rettenmeier Holzindustrie Ramstein GmbH", ort: "Ramstein-Miesenbach, Deutschland", preis: 0 },
      { firma: "EC Bioenergie GmbH", ort: "Mudau, Deutschland", preis: 0 },
      { firma: "Span-Service Holzlogistik GmbH", ort: "Edenkoben, Deutschland", preis: 0 },
      { firma: "Oberplatz Pellet GmbH", ort: "Michelsneukirchen, Deutschland", preis: 0 },
      { firma: "Allspan German Horse Produktion GmbH", ort: "Karlsruhe, Deutschland", preis: 0 },
      { firma: "Junginger Naturholzwerke GmbH", ort: "Murrhardt, Deutschland", preis: 0 },
      { firma: "Xaver Bullinger GmbH & Co. KG", ort: "Abtsgmünd, Deutschland", preis: 0 },
      { firma: "Ladenburger GmbH", ort: "Bopfingen-Aufhausen, Deutschland", preis: 0 },
      { firma: "Binderholz Deutschland GmbH", ort: "Kösching, Deutschland", preis: 0 },
      { firma: "Bayerwald Pellet GmbH & Co. KG", ort: "Regen, Deutschland", preis: 0 },
      { firma: "Sägewerke Schwaiger GmbH & Co. KG", ort: "Hengersberg, Deutschland", preis: 260 },
      { firma: "Haas Fertigbau GmbH", ort: "Falkenberg, 84326, Deutschland", preis: 230 },
      { firma: "Holzwerke Weinzierl GmbH", ort: "Vilshofen an der Donau, Deutschland", preis: 0 },
      { firma: "EC Bioenergie GmbH", ort: "Kehl, Deutschland", preis: 0 },
      { firma: "JRS Holzenergie HEW GmbH & Co. KG", ort: "Herbrechtingen, Deutschland", preis: 0 },
      { firma: "Pelletwerk Ziertheim GmbH & Co. KG", ort: "Ziertheim, Deutschland", preis: 0 },
      { firma: "Pfeifer Holz GmbH", ort: "Unterbernbach, Deutschland", preis: 0 },
      { firma: "Glecher Pellet-Produktions GmbH", ort: "Pfarrkirchen, Deutschland", preis: 0 },
      { firma: "Ante-Biopell GmbH & Co. KG", ort: "Empfingen, Deutschland", preis: 0 },
      { firma: "JRS Holzenergie HEW GmbH & Co. KG", ort: "Ettenheim, Deutschland", preis: 0 },
      { firma: "Holzwerke Gebr. Schneider GmbH", ort: "Meßkirch, Deutschland", preis: 0 },
      { firma: "EC Bioenergie GmbH", ort: "Dotternhausen, Deutschland", preis: 0 },
      { firma: "Schnellinger KG", ort: "Buchenbach, Deutschland", preis: 0 },
      { firma: "Schnellinger KG", ort: "Krauchenwies, Deutschland", preis: 0 },
      { firma: "EHO Pellets", ort: "Rohrbach an der Lafnitz, Österreich", preis: 230 },
      { firma: "Holzwerke Gebr. Schneider GmbH", ort: "Eberhardzell, Deutschland", preis: 0 },
      { firma: "Dorr-Biomassehof GmbH & Co. KG", ort: "Fuchstal-Asch, Deutschland", preis: 0 },
      { firma: "Brennpunkt Energie GmbH", ort: "Ruderatshofen, Deutschland", preis: 0 }
    { firma: "Brennpunkt Energie GmbH", ort: "rostock, deutschland", preis: 0 }
];

const gruppeGruen=L.layerGroup().addTo(map),
      gruppeOrange=L.layerGroup().addTo(map),
      gruppeRot=L.layerGroup().addTo(map),
      gruppeGrau=L.layerGroup().addTo(map);
const statusBox=document.getElementById('status');

async function buildMap(onlyMissing=false){
  [gruppeGruen,gruppeOrange,gruppeRot,gruppeGrau].forEach(g=>g.clearLayers());
  statusBox.innerHTML='';
  for(const w of werke){
    const q=w.ort;
    try{
      let c=geoCache[q];
      if(!c&&!onlyMissing){c=await geocode(q);await delay(1000);}
      if(c){
        const f=colorForPrice(w.preis);
        const t=w.preis>0?`<b>${w.preis} €</b>`:`<i style="color:gray">kein Preis</i>`;
        const m=L.circleMarker([c.lat,c.lon],{radius:8,color:f,fillColor:f,fillOpacity:.85})
          .bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${t}`,{sticky:true});
        if(f==='green')m.addTo(gruppeGruen);
        else if(f==='orange')m.addTo(gruppeOrange);
        else if(f==='red')m.addTo(gruppeRot);
        else m.addTo(gruppeGrau);
      }else{
        const p=document.createElement('div');
        p.textContent='❌ Fehlt: '+w.ort;statusBox.appendChild(p);
      }
    }catch(e){
      const p=document.createElement('div');
      p.textContent='❌ Fehler: '+w.ort+' – '+e.message;statusBox.appendChild(p);
    }
  }
}

// Filter
function updateLayers(){
  if(chkGruen.checked)map.addLayer(gruppeGruen);else map.removeLayer(gruppeGruen);
  if(chkOrange.checked)map.addLayer(gruppeOrange);else map.removeLayer(gruppeOrange);
  if(chkRot.checked)map.addLayer(gruppeRot);else map.removeLayer(gruppeRot);
  if(chkGrau.checked)map.addLayer(gruppeGrau);else map.removeLayer(gruppeGrau);
}
document.addEventListener('change',e=>{if(e.target.type==='checkbox')updateLayers();});
retryBtn.onclick=()=>buildMap(true);
clearCacheBtn.onclick=()=>{localStorage.removeItem(CACHE_KEY);alert('Geocache gelöscht – neu laden!');};
buildMap();
</script>
</body>
</html>
