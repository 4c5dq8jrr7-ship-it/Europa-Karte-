<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend,.panel{position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif}
    .legend{bottom:12px;right:12px}
    .legend i{display:inline-block;width:12px;height:12px;margin-right:6px;vertical-align:-2px}
    .panel{top:12px;left:12px;max-width:360px}
    .panel details summary{cursor:pointer;font-weight:600}
    button.small{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer}
    button.small:hover{background:#eee}
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label>
</div>

<div class="panel">
  <details open>
    <summary>Hinweise & Status</summary>
    <div style="margin-top:6px">
      ‚Ä¢ Preise & Kunden werden automatisch aus Google Sheets geladen.<br>
      ‚Ä¢ Koordinaten werden automatisch gesucht & gespeichert.<br>
    </div>
    <div style="margin-top:8px">
      <button class="small" id="retryBtn">Fehlende Orte neu suchen</button>
      <button class="small" id="clearCacheBtn">Cache leeren</button>
    </div>
    <div id="status" style="margin-top:8px;max-height:160px;overflow:auto;border-top:1px solid #eee;padding-top:6px"></div>
  </details>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([51,11],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  minZoom:4, maxZoom:10, attribution: '&copy; OpenStreetMap'
}).addTo(map);

function colorForPrice(p) {
  if (!p || p <= 0) return '#9e9e9e';
  if (p <= 260) return 'green';
  if (p < 285) return 'orange';
  return 'red';
}

const CACHE_KEY = 'geoCachePellets_EU';
const geoCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d && d.length) {
    const { lat, lon } = d[0];
    geoCache[q] = { lat: +lat, lon: +lon };
    localStorage.setItem(CACHE_KEY, JSON.stringify(geoCache));
    return geoCache[q];
  }
  throw new Error('kein Treffer f√ºr ' + q);
}
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// === Datenquellen ===
const sheetUrl = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv"; // Firmen
const kundenUrl = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv&gid=XXXXXXX"; // Kunden (gid anpassen!)

let werke = [];
let kunden = [];

const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

const gruppeGruen = L.layerGroup().addTo(map),
      gruppeOrange = L.layerGroup().addTo(map),
      gruppeRot = L.layerGroup().addTo(map),
      gruppeGrau = L.layerGroup().addTo(map),
      kundenGruppe = L.layerGroup().addTo(map);
const statusBox = document.getElementById('status');

// === Beide CSVs laden ===
Promise.all([
  fetch(sheetUrl).then(r => r.text()),
  fetch(kundenUrl).then(r => r.text())
]).then(([werkeCsv, kundenCsv]) => {
  const werkeData = Papa.parse(werkeCsv, { header: true }).data;
  const kundenData = Papa.parse(kundenCsv, { header: true }).data;
  werke = werkeData.map(r => ({
    firma: r.firma,
    ort: r.ort,
    preis: parseFloat(r.preis)
  }));
  kunden = kundenData.map(r => ({
    name: r.name,
    ort: r.ort
  }));
  buildMap();
}).catch(err => console.error("Fehler beim Laden:", err));

async function buildMap(onlyMissing = false) {
  [gruppeGruen,gruppeOrange,gruppeRot,gruppeGrau,kundenGruppe].forEach(g => g.clearLayers());
  statusBox.innerHTML = '';

  // Firmen
  for (const w of werke) {
    if (!w.firma || !w.ort) continue;
    try {
      let c = geoCache[w.ort];
      if (!c && !onlyMissing) {
        c = await geocode(w.ort);
        await delay(1000);
      }
      if (c) {
        const f = colorForPrice(w.preis);
        const t = w.preis > 0 ? `<b>${w.preis} ‚Ç¨</b>` : `<i style="color:gray">kein Preis</i>`;
        const m = L.circleMarker([c.lat, c.lon], {
          radius: 8,
          color: f,
          fillColor: f,
          fillOpacity: 0.85
        }).bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${t}`, { sticky: true });

        if (f === 'green') m.addTo(gruppeGruen);
        else if (f === 'orange') m.addTo(gruppeOrange);
        else if (f === 'red') m.addTo(gruppeRot);
        else m.addTo(gruppeGrau);
      }
    } catch (e) {
      const p = document.createElement('div');
      p.textContent = '‚ùå ' + w.ort + ' ‚Äì ' + e.message;
      statusBox.appendChild(p);
    }
  }

  // Kunden
  for (const k of kunden) {
    if (!k.name || !k.ort) continue;
    try {
      let c = geoCache[k.ort];
      if (!c && !onlyMissing) {
        c = await geocode(k.ort);
        await delay(1000);
      }
      if (c) {
        const marker = L.marker([c.lat, c.lon], { icon: blauesDreieck })
          .bindTooltip(`<b>${k.name}</b><br>${k.ort}`, { sticky: true });
        marker.addTo(kundenGruppe);
      }
    } catch (e) {
      const p = document.createElement('div');
      p.textContent = '‚ùå ' + k.ort + ' ‚Äì ' + e.message;
      statusBox.appendChild(p);
    }
  }
}

// Filter
function updateLayers() {
  if (chkGruen.checked) map.addLayer(gruppeGruen); else map.removeLayer(gruppeGruen);
  if (chkOrange.checked) map.addLayer(gruppeOrange); else map.removeLayer(gruppeOrange);
  if (chkRot.checked) map.addLayer(gruppeRot); else map.removeLayer(gruppeRot);
  if (chkGrau.checked) map.addLayer(gruppeGrau); else map.removeLayer(gruppeGrau);
  if (chkKunden.checked) map.addLayer(kundenGruppe); else map.removeLayer(kundenGruppe);
}
document.addEventListener('change', e => {
  if (e.target.type === 'checkbox') updateLayers();
});
retryBtn.onclick = () => buildMap(true);
clearCacheBtn.onclick = () => {
  localStorage.removeItem(CACHE_KEY);
  alert('Geocache gel√∂scht ‚Äì Seite neu laden!');
};
</script>
</body>
</html>
