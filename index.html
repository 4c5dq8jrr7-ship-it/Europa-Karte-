<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke â€“ Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend{
      position:absolute;z-index:1000;background:#fff;padding:10px 12px;
      border-radius:8px;box-shadow:0 2px 10px rgba(0,0,0,.15);
      font:15px/1.4 system-ui,Arial,sans-serif;bottom:12px;right:12px
    }
    .legend label{
      display:flex;
      align-items:center;
      margin-bottom:5px;
      cursor:pointer;
      gap:6px;
    }
    .legend input[type="checkbox"]{
      transform:scale(1.3);
      cursor:pointer;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> ðŸŸ¢ â‰¤ 260 â‚¬</label>
  <label><input type="checkbox" id="chkOrange" checked> ðŸŸ  260â€“285 â‚¬</label>
  <label><input type="checkbox" id="chkRot" checked> ðŸ”´ â‰¥ 285 â‚¬</label>
  <label><input type="checkbox" id="chkRosa" checked> ðŸ©· Durchschnittswert</label>
  <label><input type="checkbox" id="chkKunden" checked> ðŸ”· Kunden</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([51,11],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  minZoom:4, maxZoom:10, attribution: '&copy; OpenStreetMap'
}).addTo(map);

// === Hilfsfunktionen ===
function colorForPrice(p) {
  if (!p || p <= 0) return '#9e9e9e';
  if (p <= 260) return 'green';
  if (p < 285) return 'orange';
  return 'red';
}

const CACHE_KEY = 'geoCachePellets_EU';
const geoCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');

async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d && d.length) {
    const { lat, lon } = d[0];
    geoCache[q] = { lat: +lat, lon: +lon };
    localStorage.setItem(CACHE_KEY, JSON.stringify(geoCache));
    return geoCache[q];
  }
  throw new Error('kein Treffer fÃ¼r ' + q);
}

function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// === Kunden ===
const kunden = [
  { name: "Landhandel Niehues GmbH & Co. KG", ort: "48720 Rosendahl Holtwick, Deutschland" },
  { name: "Holzhof Dresden GmbH", ort: "01099 Dresden, Deutschland" },
  { name: "Maier & Korduletsch Energie GmbH", ort: "94474 Vilshofen, Deutschland" }
];

const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

// === Layergruppen ===
const gruppeGruen = L.layerGroup(),
      gruppeOrange = L.layerGroup(),
      gruppeRot = L.layerGroup(),
      gruppeGrau = L.layerGroup(),
      gruppeRosa = L.layerGroup(),
      kundenGruppe = L.layerGroup();

let werke = [];

// === Daten aus Google Sheets laden ===
const sheetUrl = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
Papa.parse(sheetUrl, {
  download: true,
  header: true,
  complete: async function(results) {
    werke = results.data.map(row => ({
      firma: row.firma,
      ort: row.ort,
      preis: parseFloat(row.preis)
    }));

    // Durchschnitt berechnen fÃ¼r Firmen ohne Preis
    const gueltigePreise = werke.filter(w => !isNaN(w.preis) && w.preis > 0).map(w => w.preis);
    const durchschnitt = gueltigePreise.reduce((a,b) => a+b, 0) / gueltigePreise.length;
    werke = werke.map(w => {
      if (isNaN(w.preis) || w.preis <= 0) {
        w.preis = parseFloat(durchschnitt.toFixed(2));
        w.durchschnitt = true;
      }
      return w;
    });

    await buildMap();
    updateLayers();
  }
});

// === Routing und Berechnung ===
let routeLine = null;

async function showRoute(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  if (!data.routes.length) return alert("Keine Route gefunden!");

  const route = data.routes[0];
  const dist = (route.distance / 1000).toFixed(1);
  const durationMin = route.duration / 60;
  const durationStr = `${Math.floor(durationMin / 60)} h ${Math.round(durationMin % 60)} min`;
  const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

  if (routeLine) map.removeLayer(routeLine);
  routeLine = L.polyline(coords, { color: 'black', weight: 5, opacity: 0.8 }).addTo(map);

  const mid = coords[Math.floor(coords.length / 2)];
  L.popup()
    .setLatLng(mid)
    .setContent(`<b>Route:</b> ${a.label} â†” ${b.label}<br><b>Entfernung:</b> ${dist} km<br><b>Dauer:</b> ${durationStr}`)
    .openOn(map);

  map.fitBounds(routeLine.getBounds(), { padding: [40, 40] });
}

// === NEU: GÃ¼nstigste Firma fÃ¼r Kunden finden ===
async function findeGÃ¼nstigsteFirma(kunde) {
  let ergebnisse = [];
  const kundeCoord = await geocode(kunde.ort);

  for (const w of werke) {
    if (!w.ort || !w.firma) continue;
    try {
      const firmaCoord = await geocode(w.ort);
      const url = `https://router.project-osrm.org/route/v1/driving/${kundeCoord.lon},${kundeCoord.lat};${firmaCoord.lon},${firmaCoord.lat}?overview=false`;
      const res = await fetch(url);
      const data = await res.json();
      if (!data.routes.length) continue;

      const dist = data.routes[0].distance / 1000; // km
      const preisProKm = dist < 250 ? 2.15 : 1.85;
      const teilstrecke = dist / 24;
      const gesamt = (teilstrecke * preisProKm + w.preis + 1.05).toFixed(2);

      ergebnisse.push({
        firma: w.firma,
        ort: w.ort,
        dist: dist.toFixed(1),
        preis: parseFloat(gesamt)
      });
    } catch (e) {
      console.warn("Fehler bei Route:", w.firma, e);
    }
  }

  if (!ergebnisse.length) return alert("Keine Firmen gefunden!");

  // GÃ¼nstigste Firma finden
  const guenstigste = ergebnisse.reduce((min, f) => f.preis < min.preis ? f : min, ergebnisse[0]);

  // Route anzeigen
  const firmaCoord = await geocode(guenstigste.ort);
  showRoute({ label: kunde.name, coord: kundeCoord }, { label: guenstigste.firma, coord: firmaCoord });

  // Popup mit Info
  L.popup()
    .setLatLng([kundeCoord.lat, kundeCoord.lon])
    .setContent(`
      <b>Kunde:</b> ${kunde.name}<br>
      <b>GÃ¼nstigste Firma:</b> ${guenstigste.firma}<br>
      <b>Entfernung:</b> ${guenstigste.dist} km<br>
      <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${guenstigste.preis} â‚¬</span>
    `)
    .openOn(map);
}

// === Marker-Klick ===
async function handleMarkerClick(label, coord) {
  const kunde = kunden.find(k => k.name === label);
  if (kunde) {
    await findeGÃ¼nstigsteFirma(kunde);
  } else {
    // Standard: Zwei Punkte manuell verbinden
    if (!window.selectedPoints) window.selectedPoints = [];
    window.selectedPoints.push({ label, coord });
    if (window.selectedPoints.length === 2) {
      showRoute(window.selectedPoints[0], window.selectedPoints[1]);
      window.selectedPoints = [];
    }
  }
}

// === Karte aufbauen ===
async function buildMap() {
  [gruppeGruen,gruppeOrange,gruppeRot,gruppeGrau,gruppeRosa,kundenGruppe].forEach(g => g.clearLayers());

  // Firmenmarker
  for (const w of werke) {
    if (!w.firma || !w.ort) continue;
    try {
      let c = geoCache[w.ort] || await geocode(w.ort);
      const f = w.durchschnitt ? '#ff66b3' : colorForPrice(w.preis);
      const text = w.durchschnitt ? `${w.preis} â‚¬ (Durchschnitt)` : `${w.preis} â‚¬`;
      const marker = L.circleMarker([c.lat, c.lon], { radius: 8, color: f, fillColor: f, fillOpacity: 0.85 })
        .bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br><b>${text}</b>`, { sticky: true })
        .on('click', () => handleMarkerClick(w.firma, c));

      if (w.durchschnitt) marker.addTo(gruppeRosa);
      else if (f === 'green') marker.addTo(gruppeGruen);
      else if (f === 'orange') marker.addTo(gruppeOrange);
      else if (f === 'red') marker.addTo(gruppeRot);
      else marker.addTo(gruppeGrau);
    } catch (e) { console.error(e); }
  }

  // Kundenmarker
  for (const k of kunden) {
    try {
      let c = geoCache[k.ort] || await geocode(k.ort);
      const marker = L.marker([c.lat, c.lon], { icon: blauesDreieck })
        .bindTooltip(`<b>${k.name}</b><br>${k.ort}`, { sticky: true })
        .on('click', () => handleMarkerClick(k.name, c));
      marker.addTo(kundenGruppe);
    } catch (e) { console.error(e); }
  }
}

// === Layersteuerung ===
function updateLayers() {
  const layers = {
    chkGruen: gruppeGruen,
    chkOrange: gruppeOrange,
    chkRot: gruppeRot,
    chkGrau: gruppeGrau,
    chkRosa: gruppeRosa,
    chkKunden: kundenGruppe
  };
  for (const [id, layer] of Object.entries(layers)) {
    const box = document.getElementById(id);
    if (box && box.checked) map.addLayer(layer);
    else map.removeLayer(layer);
  }
}

document.querySelectorAll('.legend input[type="checkbox"]').forEach(cb => {
  cb.addEventListener('change', updateLayers);
});
</script>
</body>
</html>
