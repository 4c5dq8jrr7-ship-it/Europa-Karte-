<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke â€“ Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend{position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;bottom:12px;right:12px}
    .legend i{display:inline-block;width:12px;height:12px;margin-right:6px;vertical-align:-2px}
    button.small{padding:6px 10px;border-radius:6px;border:1px solid #ddd;background:#f5f5f5;cursor:pointer}
    button.small:hover{background:#eee}
  </style>
</head>
<body>
<div id="map"></div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> ðŸŸ¢ â‰¤ 260 â‚¬</label><br>
  <label><input type="checkbox" id="chkOrange" checked> ðŸŸ  260â€“285 â‚¬</label><br>
  <label><input type="checkbox" id="chkRot" checked> ðŸ”´ â‰¥ 285 â‚¬</label><br>
  <label><input type="checkbox" id="chkGrau" checked> âšª kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> ðŸ”· Kunden</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map('map').setView([51,11],5);
L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png',{
  minZoom:4, maxZoom:10, attribution: '&copy; OpenStreetMap'
}).addTo(map);

function colorForPrice(p) {
  if (!p || p <= 0) return '#9e9e9e';
  if (p <= 260) return 'green';
  if (p < 285) return 'orange';
  return 'red';
}

const CACHE_KEY = 'geoCachePellets_EU';
const geoCache = JSON.parse(localStorage.getItem(CACHE_KEY) || '{}');
async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d && d.length) {
    const { lat, lon } = d[0];
    geoCache[q] = { lat: +lat, lon: +lon };
    localStorage.setItem(CACHE_KEY, JSON.stringify(geoCache));
    return geoCache[q];
  }
  throw new Error('kein Treffer fÃ¼r ' + q);
}
function delay(ms) { return new Promise(r => setTimeout(r, ms)); }

// === Kunden ===
const kunden = [
  { name: "Holzhof Dresden GmbH", ort: "01099 Dresden, Deutschland" },
  { name: "Maier & Korduletsch Energie GmbH", ort: "94474 Vilshofen, Deutschland" },
  { name: "Hubert Heitmann GmbH", ort: "21514 BÃ¼chen, Deutschland" },
  { name: "Hellmuth MineralÃ¶l GmbH & Co. KG", ort: "02730 Ebersbach-Neugersdorf, Deutschland" },  
  { name: "HessenmÃ¼hle GmbH & Co. KG", ort: "56459 GemÃ¼nden, Deutschland" },
  { name: "Wilhelm hoyer GmbH & Co. KG", ort: "37154 Northeim, Deutschland" },
  { name: "Kleeschulte GmbH & Co. KG", ort: "33142 BÃ¼ren, Deutschland" },
  { name: "Horst Korb GmbH", ort: "55765 Birkenfeld, Deutschland" },
  { name: "Landhandel Niehues GmbH & Co. KG", ort: "48720 Rosendahl, Deutschland" },
  { name: "Maurath Brennstoffe GmbH & Co. KG", ort: "77815 BÃ¼hl, Deutschland" },
  { name: "ZE Holzsysteme Vertriebsges.mnH", ort: "8234 Bad Feilnbach, Deutschland" },
  { name: "Dlask GmbH", ort: "82269 Geltendorf, Deutschland" },
  { name: "Fritz Wahr Energie GmbH & Co. KG", ort: "72202 Nagold, Deutschland" }
];

const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

const gruppeGruen = L.layerGroup().addTo(map),
      gruppeOrange = L.layerGroup().addTo(map),
      gruppeRot = L.layerGroup().addTo(map),
      gruppeGrau = L.layerGroup().addTo(map),
      kundenGruppe = L.layerGroup().addTo(map);

let werke = [];

// === Google Sheets einlesen ===
const sheetUrl = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const kundenUrl = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv&gid=1656149918";

let werke =  [];
let kunden =  [];
  
Papa.parse(sheetUrl, {
  download: true,
  header: true,
  complete: function(results) {
    werke = results.data.map(row => ({
      firma: row.firma,
      ort: row.ort,
      preis: parseFloat(row.preis)
  }));

     // Danach gleich die Kunden laden
    Papa.parse(kundenUrl, {
      download: true,
      header: true,
      complete: function(res2) {
        kunden = res2.data.map(row => ({
          name: row.name,
          ort: row.ort
        }));
        buildMap(); // Karte erst bauen, wenn beides fertig ist
      }
    });
  }
});

// === Routing mit Preisberechnung ===
let selectedPoints = [];
let routeLine = null;

function formatDuration(minutesTotal) {
  const hours = Math.floor(minutesTotal / 60);
  const minutes = Math.round(minutesTotal % 60);
  if (hours > 0) return `${hours} h ${minutes} min`;
  return `${minutes} min`;
}

async function showRoute(a, b) {
  const url = `https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();

  if (data.routes && data.routes.length) {
    const route = data.routes[0];
    const dist = (route.distance / 1000).toFixed(1);
    const durationMin = route.duration / 60;
    const durationStr = formatDuration(durationMin);
    const coords = route.geometry.coordinates.map(c => [c[1], c[0]]);

    // Preislogik
    let preisProKm = dist < 250 ? 2.15 : 1.85;

    // Firmenpreis finden
    let firmenPreis = 0;
    const firmeneintrag = werke.find(w => w.firma === a.label || w.firma === b.label);
    if (firmeneintrag && !isNaN(firmeneintrag.preis)) {
      firmenPreis = firmeneintrag.preis;
    }

    // Gesamtpreis berechnen: (km Ã· 24) Ã— Preis + Firmenpreis + 1,05
    const teilstrecke = dist / 24;
    const berechnung = teilstrecke * preisProKm;
    const gesamt = ((berechnung + firmenPreis) * 1.05).toFixed(2);

    if (routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords, { color: 'blue', weight: 5, opacity: 0.8 }).addTo(map);

    const mid = coords[Math.floor(coords.length / 2)];
    L.popup()
      .setLatLng(mid)
      .setContent(`
        <b>Route:</b> ${a.label} â†” ${b.label}<br>
        <b>Entfernung:</b> ${dist} km<br>
        <b>Dauer:</b> ${durationStr}<br>
        <b>Preis pro km:</b> ${preisProKm.toFixed(2)} â‚¬<br>
        <b>Firmenpreis:</b> ${firmenPreis ? firmenPreis.toFixed(2) + ' â‚¬' : 'â€“'}<br>
        <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${gesamt} â‚¬</span>
      `)
      .openOn(map);

    map.fitBounds(routeLine.getBounds(), { padding: [40, 40] });
  } else {
    alert("Keine Route gefunden!");
  }
}

function handleMarkerClick(label, coord) {
  selectedPoints.push({ label, coord });
  if (selectedPoints.length === 2) {
    const [a, b] = selectedPoints;
    showRoute(a, b);
    selectedPoints = [];
  }
}

async function buildMap(onlyMissing = false) {
  [gruppeGruen,gruppeOrange,gruppeRot,gruppeGrau,kundenGruppe].forEach(g => g.clearLayers());

  // Firmenmarker
  for (const w of werke) {
    if (!w.firma || !w.ort) continue;
    try {
      let c = geoCache[w.ort];
      if (!c && !onlyMissing) {
        c = await geocode(w.ort);
        await delay(1000);
      }
      if (c) {
        const f = colorForPrice(w.preis);
        const t = w.preis > 0 ? `<b>${w.preis} â‚¬</b>` : `<i style="color:gray">kein Preis</i>`;
        const marker = L.circleMarker([c.lat, c.lon], {
          radius: 8, color: f, fillColor: f, fillOpacity: 0.85
        })
        .bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${t}`, { sticky: true })
        .on('click', () => handleMarkerClick(w.firma, c));

        if (f === 'green') marker.addTo(gruppeGruen);
        else if (f === 'orange') marker.addTo(gruppeOrange);
        else if (f === 'red') marker.addTo(gruppeRot);
        else marker.addTo(gruppeGrau);
      }
    } catch (e) { console.error(e); }
  }

  // Kundenmarker
  for (const k of kunden) {
    try {
      let c = geoCache[k.ort];
      if (!c && !onlyMissing) {
        c = await geocode(k.ort);
        await delay(1000);
      }
      if (c) {
        const marker = L.marker([c.lat, c.lon], { icon: blauesDreieck })
          .bindTooltip(`<b>${k.name}</b><br>${k.ort}`, { sticky: true })
          .on('click', () => handleMarkerClick(k.name, c));
        marker.addTo(kundenGruppe);
      }
    } catch (e) { console.error(e); }
  }
}

map.on('click', () => {
  if (routeLine) {
    map.removeLayer(routeLine);
    routeLine = null;
  }
});

function updateLayers() {
  if (chkGruen.checked) map.addLayer(gruppeGruen); else map.removeLayer(gruppeGruen);
  if (chkOrange.checked) map.addLayer(gruppeOrange); else map.removeLayer(gruppeOrange);
  if (chkRot.checked) map.addLayer(gruppeRot); else map.removeLayer(gruppeRot);
  if (chkGrau.checked) map.addLayer(gruppeGrau); else map.removeLayer(gruppeGrau);
  if (chkKunden.checked) map.addLayer(kundenGruppe); else map.removeLayer(kundenGruppe);
}
document.addEventListener('change', e => {
  if (e.target.type === 'checkbox') updateLayers();
});
</script>
</body>
</html>
