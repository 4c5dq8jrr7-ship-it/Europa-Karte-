<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Pelletwerke ‚Äì Europa Preiskarte mit Sackware</title>
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
<script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
<style>
  html,body{height:100%;margin:0}
  #map{width:100%;height:100%}
  .legend{
    position:absolute;z-index:1000;background:#fff;padding:8px 10px;
    border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
    font:14px/1.3 system-ui,Arial,sans-serif;bottom:12px;right:12px
  }
  .search-box{
    position:absolute;top:12px;right:12px;z-index:1000;
    background:#fff;padding:8px 10px;border-radius:6px;
    box-shadow:0 2px 8px rgba(0,0,0,.15);
    font:14px system-ui,Arial,sans-serif
  }
  .search-box input{
    width:220px;padding:6px 8px;border:1px solid #ccc;
    border-radius:4px;outline:none;
  }
</style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶" />
</div>

<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label><br>
  <label><input type="checkbox" id="chkSackware" checked> ü©∑ Sackware</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([51, 11], 5);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 10, attribution: "&copy; OpenStreetMap"
}).addTo(map);

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

// Geocode-Cache
const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");
async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d.length) {
    geoCache[q] = { lat: +d[0].lat, lon: +d[0].lon };
    localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
    return geoCache[q];
  }
  console.warn("Kein Geocode-Treffer:", q);
  return null;
}

// Symbole
const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

const sackwareIcon = L.divIcon({
  html: `<svg width="20" height="20" viewBox="0 0 20 20">
           <rect x="2" y="2" width="16" height="16" fill="pink" stroke="black" stroke-width="1.5"/>
         </svg>`,
  iconAnchor: [10,10],
  popupAnchor: [0,-10]
});

// Layer-Gruppen
const gruppeGruen = L.layerGroup().addTo(map),
      gruppeOrange = L.layerGroup().addTo(map),
      gruppeRot = L.layerGroup().addTo(map),
      gruppeGrau = L.layerGroup().addTo(map),
      kundenGruppe = L.layerGroup().addTo(map),
      sackwareGruppe = L.layerGroup().addTo(map);

// Tabellen-Links
const sheetUrlFirmen   = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetUrlKunden   = "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";
const sheetUrlSackware = "https://docs.google.com/spreadsheets/d/1Z-qBN2-Y3kK9FK4y4mWhmvJo94OOQ96ikrISj-1_2To/export?format=csv&gid=0";

let werke = [], kunden = [], sackware = [];
let alleMarker = [];

async function ladeDaten() {
  // Firmen
  const firmenPromise = new Promise(resolve => {
    Papa.parse(sheetUrlFirmen, {
      download:true, header:true,
      complete:r=>{
        const daten = r.data.filter(x=>x.firma && x.ort).map(x=>({
          firma:x.firma.trim(), ort:x.ort.trim(),
          preis:parseFloat((x.preis||"0").replace(",","."))
        }));
        const g√ºltige = daten.filter(w=>!isNaN(w.preis)&&w.preis>0);
        const avg = g√ºltige.reduce((a,b)=>a+b.preis,0)/g√ºltige.length;
        resolve(daten.map(w=>{
          if(isNaN(w.preis)||w.preis<=0){w.preis=avg;w.keinPreis=true;}else w.keinPreis=false;
          return w;
        }));
      }
    });
  });

  // Kunden
  const kundenPromise = new Promise(resolve=>{
    Papa.parse(sheetUrlKunden,{
      download:true, header:true,
      complete:r=>{
        const nameKey=Object.keys(r.data[0]||{}).find(h=>h.toLowerCase().includes("name"))||"name";
        const ortKey = Object.keys(r.data[0]||{}).find(h=>h.toLowerCase().includes("ort"))||"ort";
        resolve(r.data.map(x=>({name:(x[nameKey]||"").trim(), ort:(x[ortKey]||"").trim()})).filter(x=>x.name&&x.ort));
      }
    });
  });

  // Sackware
  const sackwarePromise = new Promise(resolve=>{
    Papa.parse(sheetUrlSackware,{
      download:true, header:true,
      complete:r=>{
        const daten=r.data.filter(x=>x.firma&&x.ort).map(x=>({
          firma:x.firma.trim(),
          ort:x.ort.trim(),
          preis:parseFloat((x.preis||"0").replace(",","."))
        }));
        resolve(daten);
      }
    });
  });

  const [firmen,kundenDaten,sackwareDaten]=await Promise.all([firmenPromise,kundenPromise,sackwarePromise]);
  werke=firmen; kunden=kundenDaten; sackware=sackwareDaten;
}

async function buildMap(){
  const bounds=L.latLngBounds();

  // Werke
  for(const w of werke){
    const c=geoCache[w.ort]||await geocode(w.ort);
    if(!c)continue;
    const f=colorForPrice(w.preis,w.keinPreis);
    const t=w.keinPreis?`${w.preis.toFixed(2)} ‚Ç¨ (√ò)`: `${w.preis.toFixed(2)} ‚Ç¨`;
    const m=L.circleMarker([c.lat,c.lon],{radius:8,color:f,fillColor:f,fillOpacity:0.85})
      .bindTooltip(`<b>${w.firma}</b><br>${w.ort}<br>${t}`,{sticky:true});
    if(w.keinPreis)m.addTo(gruppeGrau);
    else if(f==="green")m.addTo(gruppeGruen);
    else if(f==="orange")m.addTo(gruppeOrange);
    else m.addTo(gruppeRot);
    alleMarker.push({type:"firma",name:w.firma,ort:w.ort,marker:m});
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    const c=geoCache[k.ort]||await geocode(k.ort);
    if(!c)continue;
    const m=L.marker([c.lat,c.lon],{icon:blauesDreieck})
      .bindTooltip(`<b>${k.name}</b><br>${k.ort}`,{sticky:true});
    m.addTo(kundenGruppe);
    alleMarker.push({type:"kunde",name:k.name,ort:k.ort,marker:m});
    bounds.extend([c.lat,c.lon]);
  }

  // Sackware
  for(const s of sackware){
    const c=geoCache[s.ort]||await geocode(s.ort);
    if(!c)continue;
    const t=`${s.preis.toFixed(2)} ‚Ç¨`;
    const m=L.marker([c.lat,c.lon],{icon:sackwareIcon})
      .bindTooltip(`<b>${s.firma}</b><br>${s.ort}<br>${t}`,{sticky:true});
    m.addTo(sackwareGruppe);
    alleMarker.push({type:"sackware",name:s.firma,ort:s.ort,marker:m});
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid())map.fitBounds(bounds.pad(0.2));
}

// Layer-Filter
function updateLayers(){
  if(chkGruen.checked)map.addLayer(gruppeGruen);else map.removeLayer(gruppeGruen);
  if(chkOrange.checked)map.addLayer(gruppeOrange);else map.removeLayer(gruppeOrange);
  if(chkRot.checked)map.addLayer(gruppeRot);else map.removeLayer(gruppeRot);
  if(chkGrau.checked)map.addLayer(gruppeGrau);else map.removeLayer(gruppeGrau);
  if(chkKunden.checked)map.addLayer(kundenGruppe);else map.removeLayer(kundenGruppe);
  if(chkSackware.checked)map.addLayer(sackwareGruppe);else map.removeLayer(sackwareGruppe);
}
document.addEventListener("change",e=>{if(e.target.type==="checkbox")updateLayers();});

// Suche
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const query=e.target.value.toLowerCase().trim();
    if(!query)return;
    const treffer=alleMarker.find(m=>m.name.toLowerCase().includes(query)||m.ort.toLowerCase().includes(query));
    if(treffer){
      const latlng=treffer.marker.getLatLng();
      map.setView(latlng,9);
      treffer.marker.openTooltip();
    }else alert("Kein Treffer gefunden.");
  }
});

// Start
(async ()=>{
  await ladeDaten();
  await buildMap();
  updateLayers();
})();
</script>
</body>
</html>
