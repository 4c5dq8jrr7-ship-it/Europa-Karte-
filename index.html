<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke – Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend, .cert-box, .sack-box, .ind-box{
      position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
    }
    .legend{bottom:12px;right:12px}
    .cert-box{bottom:250px;left:12px}
    .sack-box{bottom:150px;left:12px}
    .ind-box{bottom:50px;left:12px}
    .search-box{
      position:absolute;top:12px;right:12px;z-index:1000;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif
    }
    .search-box input{
      width:220px;padding:6px 8px;border:1px solid #ccc;
      border-radius:4px;outline:none;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  🔍 <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen…" />
</div>

<!-- Rechte Legende -->
<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> 🟢 ≤ 260 €</label><br>
  <label><input type="checkbox" id="chkOrange" checked> 🟠 260–285 €</label><br>
  <label><input type="checkbox" id="chkRot" checked> 🔴 ≥ 285 €</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ⚪ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> 🔷 Kunden</label>
</div>

<!-- Linke Box: Zertifikate -->
<div class="cert-box">
  <b>Zertifikate</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> ENplus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
</div>

<!-- Linke Box: Sackware -->
<div class="sack-box">
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkFireFlies" checked> FireFlies</label><br>
  <label><input type="checkbox" id="chk15kg" checked> 15 kg</label><br>
  <label><input type="checkbox" id="chkOhneSack" checked> Keine Sackware</label>
</div>

<!-- Linke Box: Industrieware -->
<div class="ind-box">
  <b>Industrieware</b><br>
  <label><input type="checkbox" id="chkIndustrie" checked> Industrieware</label><br>
  <label><input type="checkbox" id="chkOhneIndustrie" checked> Keine Industrieware</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([51, 11], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 12, attribution: "&copy; OpenStreetMap"
}).addTo(map);

let selectedPoints = [];
let routeLine = null;

// Klick auf Karte → Route & Popup löschen
map.on("click", () => {
  if(routeLine) map.removeLayer(routeLine);
  routeLine = null;
  selectedPoints = [];
  map.closePopup();
});

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");
async function geocode(q

