<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pelletwerke ‚Äì Europa Preiskarte</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://cdn.jsdelivr.net/npm/papaparse@5.4.1/papaparse.min.js"></script>
  <style>
    html,body{height:100%;margin:0}
    #map{width:100%;height:100%}
    .legend, .cert-box, .sack-box, .ind-box{
      position:absolute;z-index:1000;background:#fff;padding:8px 10px;
      border-radius:6px;box-shadow:0 2px 8px rgba(0,0,0,.12);
      font:14px/1.3 system-ui,Arial,sans-serif;
    }
    .legend{bottom:12px;right:12px}
    .cert-box{bottom:250px;left:12px}
    .sack-box{bottom:150px;left:12px}
    .ind-box{bottom:50px;left:12px}
    .search-box{
      position:absolute;top:12px;right:12px;z-index:1000;
      background:#fff;padding:8px 10px;border-radius:6px;
      box-shadow:0 2px 8px rgba(0,0,0,.15);
      font:14px system-ui,Arial,sans-serif
    }
    .search-box input{
      width:220px;padding:6px 8px;border:1px solid #ccc;
      border-radius:4px;outline:none;
    }
  </style>
</head>
<body>
<div id="map"></div>

<div class="search-box">
  üîç <input type="text" id="searchInput" placeholder="Firma, Kunde oder Ort suchen‚Ä¶" />
</div>

<!-- Rechte Legende -->
<div class="legend">
  <b>Filter Farben</b><br>
  <label><input type="checkbox" id="chkGruen" checked> üü¢ ‚â§ 260 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkOrange" checked> üü† 260‚Äì285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkRot" checked> üî¥ ‚â• 285 ‚Ç¨</label><br>
  <label><input type="checkbox" id="chkGrau" checked> ‚ö™ kein Preis</label><br>
  <label><input type="checkbox" id="chkKunden" checked> üî∑ Kunden</label>
</div>

<!-- Linke Box: Zertifikate -->
<div class="cert-box">
  <b>Zertifikate</b><br>
  <label><input type="checkbox" id="chkEnPlus" checked> ENplus</label><br>
  <label><input type="checkbox" id="chkDINplus" checked> DINplus</label><br>
  <label><input type="checkbox" id="chkSURE" checked> SURE</label><br>
  <label><input type="checkbox" id="chkOhneZert" checked> Kein Zertifikat</label>
</div>

<!-- Linke Box: Sackware -->
<div class="sack-box">
  <b>Sackware</b><br>
  <label><input type="checkbox" id="chkFireFlies" checked> FireFlies</label><br>
  <label><input type="checkbox" id="chk15kg" checked> 15 kg</label>
</div>

<!-- Linke Box: Industrieware -->
<div class="ind-box">
  <b>Industrieware</b><br>
  <label><input type="checkbox" id="chkIndustrie" checked> Industrieware</label>
</div>

<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script>
const map = L.map("map").setView([51, 11], 6);
L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
  minZoom: 4, maxZoom: 12, attribution: "&copy; OpenStreetMap"
}).addTo(map);

let selectedPoints = [];
let routeLine = null;

map.on("click", () => {
  if(routeLine) map.removeLayer(routeLine);
  routeLine = null;
  selectedPoints = [];
  map.closePopup();
});

function colorForPrice(p, keinPreis) {
  if (keinPreis) return "#9e9e9e";
  if (!p || p <= 0) return "#9e9e9e";
  if (p <= 260) return "green";
  if (p < 285) return "orange";
  return "red";
}

const geoCache = JSON.parse(localStorage.getItem("geoCachePellets_EU") || "{}");
async function geocode(q) {
  if (geoCache[q]) return geoCache[q];
  const r = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(q)}&limit=1&accept-language=de`);
  const d = await r.json();
  if (d.length) {
    geoCache[q] = { lat: +d[0].lat, lon: +d[0].lon };
    localStorage.setItem("geoCachePellets_EU", JSON.stringify(geoCache));
    return geoCache[q];
  }
  return null;
}

const blauesDreieck = L.divIcon({
  className: "custom-triangle",
  html: `<svg width="24" height="24" viewBox="0 0 24 24">
           <polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/>
         </svg>`,
  iconAnchor: [12,22],
  popupAnchor: [0,-20]
});

const sheetUrlFirmen = "https://docs.google.com/spreadsheets/d/1f1oD1TlYWPRbD12d05yIGkqmXVygVt3ZHLk9U0bKoTs/export?format=csv";
const sheetUrlKunden = "https://docs.google.com/spreadsheets/d/1DaiLyZbhJkdSQ1PHbJQmguIrDnGrrhiAVgJC4PJO8vA/export?format=csv&gid=0";

let werke = [], kunden = [], alleMarker = [];

async function ladeDaten() {
  const firmenPromise = new Promise((resolve) => {
    Papa.parse(sheetUrlFirmen, {
      download: true, header: true,
      complete: (r) => {
        const headers = Object.keys(r.data[0] || {});
        const zertKey  = headers.find(h => h.toLowerCase().includes("zert")) || "Zertifikate";
        const sackKey  = headers.find(h => h.toLowerCase().includes("sack")) || "Sackware";
        const indKey   = headers.find(h => h.toLowerCase().includes("industrie")) || "Industrieware";
        // Spalte E (Sackwarenpreis) ‚Äì versuche Header-Namen zu erkennen:
        const sackPreisKey = headers.find(h => h.toLowerCase().includes("sack") && h.toLowerCase().includes("preis")) || "sackpreis";

        const daten = r.data
          .filter(x => x.firma && x.ort)
          .map(x => ({
            firma: (x.firma || "").trim(),
            ort:   (x.ort   || "").trim(),
            preis: parseFloat((x.preis || "0").replace(",", ".")),                 // Industriepreis
            sackpreis: parseFloat((x[sackPreisKey] || "0").replace(",", ".")),    // Sackwarenpreis (Spalte E)
            zert:  (x[zertKey] || "").trim(),
            sack:  (x[sackKey] || "").trim(),
            industrie: (x[indKey] || "").trim()
          }));

        const gueltige = daten.filter(w => !isNaN(w.preis) && w.preis > 0);
        const avg = gueltige.length ? gueltige.reduce((a,b)=>a+b.preis,0)/gueltige.length : 0;

        resolve(daten.map(w=>{
          if(isNaN(w.preis)||w.preis<=0){w.preis=avg;w.keinPreis=true;}else w.keinPreis=false;
          return w;
        }));
      }
    });
  });

  const kundenPromise = new Promise((resolve)=>{
    Papa.parse(sheetUrlKunden, {
      download:true, header:true,
      complete:(r)=>{
        const headers = Object.keys(r.data[0]||{});
        const nameKey = headers.find(h=>h.toLowerCase().includes("name"))||"name";
        const ortKey  = headers.find(h=>["ort","adresse","standort","anschrift"].includes(h.toLowerCase()))||"ort";
        resolve(
          r.data
           .map(x=>({name:(x[nameKey]||"").trim(), ort:(x[ortKey]||"").trim()}))
           .filter(x=>x.name && x.ort)
        );
      }
    });
  });

  const [firmen, kundenDaten] = await Promise.all([firmenPromise, kundenPromise]);
  werke = firmen;
  kunden = kundenDaten;
}

async function showRoute(a,b){
  const url = `https://router.project-osrm.org/route/v1/driving/${a.coord.lon},${a.coord.lat};${b.coord.lon},${b.coord.lat}?overview=full&geometries=geojson`;
  const res = await fetch(url);
  const data = await res.json();
  if(data.routes && data.routes.length){
    const route = data.routes[0];
    const dist = (route.distance/1000).toFixed(1);
    const durationMin = route.duration/60;
    const hours = Math.floor(durationMin/60);
    const minutes = Math.round(durationMin%60);
    const durationStr = hours>0?`${hours}h ${minutes}min`:`${minutes}min`;
    const coords = route.geometry.coordinates.map(c=>[c[1],c[0]]);

    // Sackwarenmodus: wenn irgendeine Sackware-Checkbox aktiv ist
    const sackMode = document.getElementById("chkFireFlies").checked || document.getElementById("chk15kg").checked;
    const preisProKm = parseFloat(dist) < 250 ? 2.15 : 1.85;

    // Preis an einem beteiligten Werk ablesen (wenn vorhanden)
    // (Ist einer der Punkte eine Firma? Dann nimm dessen Preis.)
    const firmeneintrag =
      werke.find(w => w.firma === a.label) ||
      werke.find(w => w.firma === b.label) || null;

    const basisPreis = firmeneintrag
      ? (sackMode && !isNaN(firmeneintrag.sackpreis) && firmeneintrag.sackpreis > 0
          ? firmeneintrag.sackpreis
          : firmeneintrag.preis)
      : 0;

    const teilstrecke = parseFloat(dist) / 24;
    const berechnung = teilstrecke * preisProKm;
    const gesamt = ((berechnung + basisPreis) * 1.05).toFixed(2);

    if(routeLine) map.removeLayer(routeLine);
    routeLine = L.polyline(coords,{color:'blue',weight:5,opacity:0.9}).addTo(map);
    const mid = coords[Math.floor(coords.length/2)];

    L.popup({autoClose:false, closeOnClick:false})
      .setLatLng(mid)
      .setContent(`
        <b>Route:</b> ${a.label} ‚Üî ${b.label}<br>
        <b>Entfernung:</b> ${dist} km<br>
        <b>Dauer:</b> ${durationStr}<br>
        <b>Preis pro km:</b> ${preisProKm.toFixed(2)} ‚Ç¨<br>
        <b>${sackMode ? "Sackwarenpreis" : "Industriepreis"}:</b> ${basisPreis.toFixed(2)} ‚Ç¨<br>
        <b>Gesamtkosten:</b> <span style="color:green;font-size:1.1em">${gesamt} ‚Ç¨</span>
      `)
      .openOn(map);

    map.fitBounds(routeLine.getBounds(), {padding:[20,20]});
  } else {
    alert("Keine Route gefunden!");
  }
}

function handleMarkerClick(label,coord){
  selectedPoints.push({label,coord});
  if(selectedPoints.length===2){
    const [a,b]=selectedPoints;
    showRoute(a,b);
    selectedPoints=[];
  }
}

async function buildMap(){
  alleMarker = [];
  const bounds=L.latLngBounds();

  // Firmen
  for(const w of werke){
    const c=geoCache[w.ort]||await geocode(w.ort);
    if(!c) continue;

    const f=colorForPrice(w.preis,w.keinPreis);
    let info = `<b>${w.firma}</b><br>${w.ort}<br>${w.preis.toFixed(2)} ‚Ç¨`;
    if (w.zert) info += `<br><b>Zertifikate:</b> ${w.zert}`;
    if (w.sack) info += `<br><b>Sackware:</b> ${w.sack}`;
    if (w.industrie) info += `<br><b>Industrieware:</b> ${w.industrie}`;

    const m=L.circleMarker([c.lat,c.lon],{
      radius:8,color:f,weight:1.5,fillColor:f,fillOpacity:0.85
    }).bindTooltip(info,{sticky:true})
      .on("click",()=>handleMarkerClick(w.firma,c));

    alleMarker.push({
      type:"firma",
      name:w.firma,
      ort:w.ort,
      zert:(w.zert||"").toLowerCase(),
      sack:(w.sack||"").toLowerCase(),
      industrie:(w.industrie||"").toLowerCase(),
      farbe:f,
      marker:m
    });
    bounds.extend([c.lat,c.lon]);
  }

  // Kunden
  for(const k of kunden){
    const c=geoCache[k.ort]||await geocode(k.ort);
    if(!c) continue;

    const m=L.marker([c.lat,c.lon],{
      icon:L.divIcon({
        className:"custom-triangle",
        html:`<svg width="24" height="24" viewBox="0 0 24 24"><polygon points="12,2 22,22 2,22" fill="blue" stroke="black" stroke-width="1"/></svg>`,
        iconAnchor:[12,22], popupAnchor:[0,-20]
      })
    }).bindTooltip(`<b>${k.name}</b><br>${k.ort}`,{sticky:true})
      .on("click",()=>handleMarkerClick(k.name,c));

    alleMarker.push({
      type:"kunde",
      name:k.name,
      ort:k.ort,
      marker:m
    });
    bounds.extend([c.lat,c.lon]);
  }

  if(bounds.isValid()) map.fitBounds(bounds.pad(0.15));
  updateLayers(); // Filter initial anwenden
}

// ==== FILTER-LOGIK ====
function updateLayers(){
  // alles erstmal entfernen
  alleMarker.forEach(m=>map.removeLayer(m.marker));

  // Checkbox-Zust√§nde
  const gruen  = document.getElementById("chkGruen").checked;
  const orange = document.getElementById("chkOrange").checked;
  const rot    = document.getElementById("chkRot").checked;
  const grau   = document.getElementById("chkGrau").checked;
  const kundenAn = document.getElementById("chkKunden").checked;

  const en   = document.getElementById("chkEnPlus").checked;
  const din  = document.getElementById("chkDINplus").checked;
  const sure = document.getElementById("chkSURE").checked;
  const ohneZ = document.getElementById("chkOhneZert").checked;

  const fire = document.getElementById("chkFireFlies").checked;
  const sack15 = document.getElementById("chk15kg").checked;

  const indOnly = document.getElementById("chkIndustrie").checked;

  // Pr√ºfer, ob in Gruppe √ºberhaupt etwas aktiv ist
  const zertGruppeAktiv = en || din || sure || ohneZ;           // wenn nichts an ‚Üí kein Zertifikat-Filter
  const sackGruppeAktiv = fire || sack15;                       // wenn nichts an ‚Üí kein Sack-Filter
  const indGruppeAktiv  = indOnly;                              // wenn aus ‚Üí kein Industrie-Filter

  for(const m of alleMarker){
    if(m.type === "kunde"){
      if(kundenAn) map.addLayer(m.marker);
      continue;
    }

    // Preis-Farbfilter
    if((m.farbe==="green" && !gruen) ||
       (m.farbe==="orange" && !orange) ||
       (m.farbe==="red" && !rot) ||
       (m.farbe==="#9e9e9e" && !grau)) {
      continue;
    }

    // Zertifikate
    if (zertGruppeAktiv){
      const z = (m.zert||"");
      const hatKeinZert = z.trim() === "";
      const zertOk = (hatKeinZert && ohneZ) ||
                     (!hatKeinZert && (
                        (en && z.includes("enplus")) ||
                        (din && z.includes("dinplus")) ||
                        (sure && z.includes("sure"))
                      ));
      if(!zertOk) continue;
    }

    // Sackware
    if (sackGruppeAktiv){
      const s = (m.sack||"");
      const sackOk = (fire && s.includes("fireflies")) || (sack15 && s.includes("15"));
      if(!sackOk) continue;
    }

    // Industrieware
    if (indGruppeAktiv){
      const i = (m.industrie||"").trim();
      const indOk = i !== ""; // nur zeigen, wenn Industrieware vorhanden
      if(!indOk) continue;
    }

    map.addLayer(m.marker);
  }
}

// Events
document.addEventListener("change", e => {
  if(e.target.type === "checkbox") updateLayers();
});

// Suche (einfach in Tooltip-Text)
document.getElementById("searchInput").addEventListener("keydown",e=>{
  if(e.key==="Enter"){
    const query = e.target.value.toLowerCase().trim();
    if(!query) return;
    const treffer = alleMarker.find(m=>{
      const tt = m.marker.getTooltip && m.marker.getTooltip().getContent().toLowerCase();
      return tt ? tt.includes(query) : false;
    });
    if(treffer){
      const latlng=treffer.marker.getLatLng();
      map.setView(latlng,9);
      treffer.marker.openTooltip();
    }else{
      alert("Kein Treffer gefunden.");
    }
  }
});

(async ()=>{
  await ladeDaten();
  await buildMap();
})();
</script>
</body>
</html>
